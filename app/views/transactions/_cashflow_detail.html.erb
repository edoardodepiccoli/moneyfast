<% 
  detail = CashflowCalculationService.new(user).detail
  total_cashflow = detail[:total_cashflow]
  total_ins_sum = detail[:total_ins]
  total_outs_sum = detail[:total_outs]
  monthly_cashflow = detail[:monthly_cashflow]
  monthly_breakdown = detail[:monthly_breakdown]
  average_cashflow = detail[:average_cashflow]
  monthly_trends = detail[:monthly_trends]
  max_amount = detail[:max_amount_for_chart]
  current_month = Date.current.beginning_of_month
%>

<%= turbo_frame_tag "cashflow_card" do %>
  <div class="card bg-light mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">Cashflow Overview</h5>
      
      <div>
        <div class="d-flex align-items-baseline gap-2 mb-1">
          <span class="display-6 fw-bold <%= total_cashflow >= 0 ? 'text-success' : 'text-danger' %>">
            <%= number_to_currency(total_cashflow, unit: "€") %>
          </span>
          <span class="text-muted" style="font-size: 0.7rem;">Total Cashflow</span>
        </div>

        <div class="d-flex gap-4 small mb-4">
          <span class="text-success fw-medium">
            In: <%= number_to_currency(total_ins_sum, unit: "€") %>
          </span>
          <span class="text-danger fw-medium">
            Out: -<%= number_to_currency(total_outs_sum.abs, unit: "€") %>
          </span>
        </div>

        <% if monthly_cashflow.any? %>

          <!-- Monthly Breakdown -->
          <div>
            <% monthly_cashflow.each_with_index do |(month, amount), index| %>
              <% month_data = monthly_breakdown[month] %>
              <% is_future_month = month > current_month %>
              <% trend_change = monthly_trends[month] %>
              <% is_above_average = amount > average_cashflow %>
              <% is_below_average = amount < average_cashflow %>
              <% zebra_class = index.even? ? 'bg-secondary bg-opacity-10' : 'bg-white' %>
              
              <div class="d-flex flex-column gap-2 p-3 <%= zebra_class %>">
                <!-- Row 1: Month name, Amount, and Trend (mobile-friendly) -->
                <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                  <div class="small fw-medium <%= is_future_month ? 'text-warning' : '' %>">
                    <%= month.strftime("%b %Y") %>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <% if trend_change %>
                      <span class="text-nowrap <%= trend_change >= 0 ? 'text-success' : 'text-danger' %>" style="font-size: 0.7rem;">
                        <% if trend_change > 0 %>
                          ↑
                        <% elsif trend_change < 0 %>
                          ↓
                        <% end %>
                        <%= trend_change.abs.round(1) %>%
                      </span>
                    <% end %>
                    <span class="small fw-semibold text-nowrap <%= amount >= 0 ? 'text-success' : 'text-danger' %>">
                      <%= number_to_currency(amount, unit: "€") %>
                    </span>
                  </div>
                </div>
                
                <!-- Row 2: Bar chart (full width on mobile) -->
                <div class="position-relative" style="height: 24px; background-color: #dee2e6; border-radius: 0.25rem; overflow: hidden;">
                  <div 
                    class="h-100 <%= amount >= 0 ? 'bg-success' : 'bg-danger' %> rounded transition-all"
                    style="width: <%= max_amount > 0 ? (amount.abs / max_amount * 100) : 0 %>%; transition-duration: 0.5s;"
                  ></div>
                </div>
                
                <!-- Row 3: Ins/Outs breakdown -->
                <% if month_data %>
                  <div class="d-flex align-items-center gap-3 flex-wrap" style="font-size: 0.7rem;">
                    <span class="text-success">
                      +<%= number_to_currency(month_data[:ins], unit: "€") %>
                    </span>
                    <span class="text-danger">
                      <%= number_to_currency(month_data[:outs], unit: "€") %>
                    </span>
                    <% if month_data[:count] %>
                      <span class="text-muted">
                        (<%= pluralize(month_data[:count], 'transaction') %>)
                      </span>
                    <% end %>
                  </div>
                  
                  <!-- Row 4: Category breakdown -->
                  <% ins_by_category = month_data[:ins_by_category] || {} %>
                  <% outs_by_category = month_data[:outs_by_category] || {} %>
                  <% total_ins_for_month = month_data[:ins].to_f %>
                  <% total_outs_for_month = month_data[:outs].to_f %>
                  <% if ins_by_category.any? || outs_by_category.any? %>
                    <div class="mt-2 row g-3" style="font-size: 0.7rem;">
                      <div class="col-12">
                        <div class="fw-semibold text-muted mb-1">Income categories</div>
                        <% if ins_by_category.any? %>
                          <ul class="list-unstyled mb-0">
                            <% ins_by_category.each do |category, amount_in| %>
                              <% percentage = total_ins_for_month != 0 ? ((amount_in / total_ins_for_month.abs) * 100).round(1) : 0 %>
                              <li class="d-flex justify-content-between gap-2 mb-1">
                                <span class="text-truncate">
                                  <%= category.presence || "Uncategorized" %>
                                  <span class="text-muted">(<%= percentage %>%)</span>
                                </span>
                                <span class="text-success text-nowrap">
                                  +<%= number_to_currency(amount_in, unit: "€") %>
                                </span>
                              </li>
                            <% end %>
                          </ul>
                        <% else %>
                          <div class="text-muted fst-italic">No income</div>
                        <% end %>
                      </div>
                      <div class="col-12">
                        <div class="fw-semibold text-muted mb-1">Outcome categories</div>
                        <% if outs_by_category.any? %>
                          <ul class="list-unstyled mb-0">
                            <% outs_by_category.each do |category, amount_out| %>
                              <% percentage = total_outs_for_month != 0 ? ((amount_out.abs / total_outs_for_month.abs) * 100).round(1) : 0 %>
                              <li class="d-flex justify-content-between gap-2 mb-1">
                                <span class="text-truncate">
                                  <%= category.presence || "Uncategorized" %>
                                  <span class="text-muted">(<%= percentage %>%)</span>
                                </span>
                                <span class="text-danger text-nowrap">
                                  <%= number_to_currency(amount_out, unit: "€") %>
                                </span>
                              </li>
                            <% end %>
                          </ul>
                        <% else %>
                          <div class="text-muted fst-italic">No outcome</div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="small text-muted fst-italic mb-0">No transactions yet</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
