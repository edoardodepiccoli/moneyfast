<% 
  processed_transactions = user.transactions.processed
  monthly_cashflow = processed_transactions
    .group_by { |t| t.date.beginning_of_month }
    .transform_values { |transactions| transactions.sum(&:amount) }
    .sort_by { |month, _| month }
    .reverse
    .to_h
  
  monthly_breakdown = processed_transactions
    .group_by { |t| t.date.beginning_of_month }
    .transform_values do |transactions|
      {
        ins: transactions.select { |t| t.amount > 0 }.sum(&:amount),
        outs: transactions.select { |t| t.amount < 0 }.sum(&:amount)
      }
    end
    .sort_by { |month, _| month }
    .reverse
    .to_h
  
  total_cashflow = processed_transactions.sum(&:amount)
  current_month = Date.current.beginning_of_month
%>

<%= turbo_frame_tag "cashflow_card" do %>
  <div class="card bg-base-200 border border-base-300 p-4">
    <div class="card-body p-0">
      <h2 class="card-title text-base-content">Cashflow Overview</h2>
      
      <div>
        <div class="flex items-baseline gap-2">
          <span class="text-3xl font-bold <%= total_cashflow >= 0 ? 'text-success' : 'text-error' %>">
            <%= number_to_currency(total_cashflow, unit: "€") %>
          </span>
          <span class="text-sm text-base-content/60">Total Cashflow</span>
        </div>

        <% if monthly_cashflow.any? %>
          <% amounts = monthly_cashflow.values.map(&:abs).sort %>
          <% percentile_index = [(amounts.size * 0.90).ceil - 1, 0].max %>
          <% max_amount = amounts[percentile_index] %>
          <div class="space-y-3 mt-4">
            <% monthly_cashflow.each do |month, amount| %>
              <% month_data = monthly_breakdown[month] %>
              <% is_future_month = month > current_month %>
              <div class="flex flex-col gap-1 border-b border-base-300 pb-2">
                <div class="flex items-center gap-3">
                  <div class="w-20 text-xs <%= is_future_month ? 'text-warning' : 'text-base-content/70' %> flex-shrink-0">
                    <%= month.strftime("%b %Y") %>
                  </div>
                  <div class="flex-1 relative h-8 bg-base-300 rounded overflow-hidden">
                    <div 
                      class="h-full <%= amount >= 0 ? 'bg-success' : 'bg-error' %> rounded transition-all duration-500"
                      style="width: <%= max_amount > 0 ? (amount.abs / max_amount * 100) : 0 %>%"
                    ></div>
                  </div>
                  <div class="w-24 text-right flex-shrink-0">
                    <span class="text-xs font-semibold <%= amount >= 0 ? 'text-success' : 'text-error' %>">
                      <%= number_to_currency(amount, unit: "€") %>
                    </span>
                  </div>
                </div>
                <% if month_data %>
                  <div class="flex items-center gap-3 ml-20">
                    <div class="flex gap-3 text-xs">
                      <span class="text-success">
                        +<%= number_to_currency(month_data[:ins], unit: "€") %>
                      </span>
                      <span class="text-error">
                        <%= number_to_currency(month_data[:outs], unit: "€") %>
                      </span>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-base-content/60 italic">No transactions yet</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

