<% 
  detail = CashflowCalculationService.new(user).detail
  total_cashflow = detail[:total_cashflow]
  total_ins_sum = detail[:total_ins]
  total_outs_sum = detail[:total_outs]
  monthly_cashflow = detail[:monthly_cashflow]
  monthly_breakdown = detail[:monthly_breakdown]
  average_cashflow = detail[:average_cashflow]
  monthly_trends = detail[:monthly_trends]
  max_amount = detail[:max_amount_for_chart]
  current_month = Date.current.beginning_of_month
%>

<%= turbo_frame_tag "cashflow_card" do %>
  <div class="card bg-base-200 p-4">
    <div class="card-body p-0">
      <h2 class="card-title text-base-content">Cashflow Overview</h2>
      
      <div>
        <div class="flex items-baseline gap-2 mb-1">
          <span class="text-3xl font-bold <%= total_cashflow >= 0 ? 'text-success' : 'text-error' %>">
            <%= number_to_currency(total_cashflow, unit: "€") %>
          </span>
          <span class="text-xs text-base-content/60">Total Cashflow</span>
        </div>

        <div class="flex gap-4 text-sm text-base-content/70 mb-6">
          <span class="text-success font-medium">
            In: <%= number_to_currency(total_ins_sum, unit: "€") %>
          </span>
          <span class="text-error font-medium">
            Out: -<%= number_to_currency(total_outs_sum.abs, unit: "€") %>
          </span>
        </div>

        <% if monthly_cashflow.any? %>

          <!-- Monthly Breakdown -->
          <div class="space-y-4">
            <% monthly_cashflow.each_with_index do |(month, amount), index| %>
              <% month_data = monthly_breakdown[month] %>
              <% is_future_month = month > current_month %>
              <% trend_change = monthly_trends[month] %>
              <% is_above_average = amount > average_cashflow %>
              <% is_below_average = amount < average_cashflow %>
              <% zebra_class = index.even? ? 'bg-base-300/40' : 'bg-base-100/40' %>
              <% highlight_class = is_above_average ? 'ring-1 ring-success/50' : (is_below_average ? 'ring-1 ring-error/50' : '') %>
              
              <div class="flex flex-col gap-2 pb-3 rounded px-3 py-3 border border-base-300 shadow-sm <%= zebra_class %> <%= highlight_class %>">
                <!-- Row 1: Month name, Amount, and Trend (mobile-friendly) -->
                <div class="flex items-center justify-between gap-2 flex-wrap">
                  <div class="text-sm font-medium <%= is_future_month ? 'text-warning' : 'text-base-content' %>">
                    <%= month.strftime("%b %Y") %>
                  </div>
                  <div class="flex items-center gap-2">
                    <% if trend_change %>
                      <span class="text-xs <%= trend_change >= 0 ? 'text-success' : 'text-error' %> whitespace-nowrap">
                        <% if trend_change > 0 %>
                          ↑
                        <% elsif trend_change < 0 %>
                          ↓
                        <% end %>
                        <%= trend_change.abs.round(1) %>%
                      </span>
                    <% end %>
                    <span class="text-sm font-semibold <%= amount >= 0 ? 'text-success' : 'text-error' %> whitespace-nowrap">
                      <%= number_to_currency(amount, unit: "€") %>
                    </span>
                  </div>
                </div>
                
                <!-- Row 2: Bar chart (full width on mobile) -->
                <div class="relative h-6 bg-base-300 rounded overflow-hidden">
                  <div 
                    class="h-full <%= amount >= 0 ? 'bg-success' : 'bg-error' %> rounded transition-all duration-500"
                    style="width: <%= max_amount > 0 ? (amount.abs / max_amount * 100) : 0 %>%"
                  ></div>
                </div>
                
                <!-- Row 3: Ins/Outs breakdown -->
                <% if month_data %>
                  <div class="flex items-center gap-3 flex-wrap text-xs">
                    <span class="text-success">
                      +<%= number_to_currency(month_data[:ins], unit: "€") %>
                    </span>
                    <span class="text-error">
                      <%= number_to_currency(month_data[:outs], unit: "€") %>
                    </span>
                    <% if month_data[:count] %>
                      <span class="text-base-content/50">
                        (<%= pluralize(month_data[:count], 'transaction') %>)
                      </span>
                    <% end %>
                  </div>
                  
                  <!-- Row 4: Category breakdown -->
                  <% ins_by_category = month_data[:ins_by_category] || {} %>
                  <% outs_by_category = month_data[:outs_by_category] || {} %>
                  <% total_ins_for_month = month_data[:ins].to_f %>
                  <% total_outs_for_month = month_data[:outs].to_f %>
                  <% if ins_by_category.any? || outs_by_category.any? %>
                    <div class="mt-2 grid grid-cols-1 gap-3 text-xs">
                      <div>
                        <div class="font-semibold text-base-content/70 mb-1">Income categories</div>
                        <% if ins_by_category.any? %>
                          <ul class="space-y-0.5">
                            <% ins_by_category.each do |category, amount_in| %>
                              <% percentage = total_ins_for_month != 0 ? ((amount_in / total_ins_for_month.abs) * 100).round(1) : 0 %>
                              <li class="flex justify-between gap-2">
                                <span class="truncate">
                                  <%= category.presence || "Uncategorized" %>
                                  <span class="text-base-content/40">(<%= percentage %>%)</span>
                                </span>
                                <span class="text-success whitespace-nowrap">
                                  +<%= number_to_currency(amount_in, unit: "€") %>
                                </span>
                              </li>
                            <% end %>
                          </ul>
                        <% else %>
                          <div class="text-base-content/40 italic">No income</div>
                        <% end %>
                      </div>
                      <div>
                        <div class="font-semibold text-base-content/70 mb-1">Outcome categories</div>
                        <% if outs_by_category.any? %>
                          <ul class="space-y-0.5">
                            <% outs_by_category.each do |category, amount_out| %>
                              <% percentage = total_outs_for_month != 0 ? ((amount_out.abs / total_outs_for_month.abs) * 100).round(1) : 0 %>
                              <li class="flex justify-between gap-2">
                                <span class="truncate">
                                  <%= category.presence || "Uncategorized" %>
                                  <span class="text-base-content/40">(<%= percentage %>%)</span>
                                </span>
                                <span class="text-error whitespace-nowrap">
                                  <%= number_to_currency(amount_out, unit: "€") %>
                                </span>
                              </li>
                            <% end %>
                          </ul>
                        <% else %>
                          <div class="text-base-content/40 italic">No outcome</div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-base-content/60 italic">No transactions yet</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

