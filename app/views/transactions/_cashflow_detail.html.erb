<% 
  processed_transactions = user.transactions.processed
  monthly_cashflow = processed_transactions
    .group_by { |t| t.date.beginning_of_month }
    .transform_values { |transactions| transactions.sum(&:amount) }
    .sort_by { |month, _| month }
    .reverse
    .to_h
  
  monthly_breakdown = processed_transactions
    .group_by { |t| t.date.beginning_of_month }
    .transform_values do |transactions|
      {
        ins: transactions.select { |t| t.amount > 0 }.sum(&:amount),
        outs: transactions.select { |t| t.amount < 0 }.sum(&:amount),
        count: transactions.size
      }
    end
    .sort_by { |month, _| month }
    .reverse
    .to_h
  
  total_cashflow = processed_transactions.sum(&:amount)
  current_month = Date.current.beginning_of_month
  
  # Calculate averages and trends
  average_cashflow = monthly_cashflow.any? ? (monthly_cashflow.values.sum.to_f / monthly_cashflow.size) : 0
  best_month = monthly_cashflow.max_by { |_, amount| amount } if monthly_cashflow.any?
  worst_month = monthly_cashflow.min_by { |_, amount| amount } if monthly_cashflow.any?
  
  # Calculate month-over-month changes
  monthly_trends = {}
  monthly_cashflow_array = monthly_cashflow.to_a
  monthly_cashflow_array.each_with_index do |(month, amount), index|
    if index < monthly_cashflow_array.size - 1
      previous_amount = monthly_cashflow_array[index + 1][1]
      if previous_amount != 0
        change = ((amount - previous_amount) / previous_amount.abs) * 100
        monthly_trends[month] = change
      else
        monthly_trends[month] = amount > 0 ? 100 : (amount < 0 ? -100 : 0)
      end
    end
  end
  
  # Calculate overall trend (comparing last 3 months to previous 3 months)
  if monthly_cashflow_array.size >= 6
    recent_3_months = monthly_cashflow_array[0..2].map { |_, amount| amount }.sum
    previous_3_months = monthly_cashflow_array[3..5].map { |_, amount| amount }.sum
    overall_trend = previous_3_months != 0 ? ((recent_3_months - previous_3_months) / previous_3_months.abs) * 100 : 0
  elsif monthly_cashflow_array.size >= 2
    recent_avg = monthly_cashflow_array[0..[1, monthly_cashflow_array.size - 1].min].map { |_, amount| amount }.sum.to_f / [2, monthly_cashflow_array.size].min
    previous_avg = monthly_cashflow_array[[2, monthly_cashflow_array.size - 1].min..-1].map { |_, amount| amount }.sum.to_f / [monthly_cashflow_array.size - 2, 1].max
    overall_trend = previous_avg != 0 ? ((recent_avg - previous_avg) / previous_avg.abs) * 100 : 0
  else
    overall_trend = 0
  end
%>

<%= turbo_frame_tag "cashflow_card" do %>
  <div class="card bg-base-200 p-4">
    <div class="card-body p-0">
      <h2 class="card-title text-base-content">Cashflow Overview</h2>
      
      <div>
        <div class="flex items-baseline gap-2 mb-4">
          <span class="text-3xl font-bold <%= total_cashflow >= 0 ? 'text-success' : 'text-error' %>">
            <%= number_to_currency(total_cashflow, unit: "€") %>
          </span>
          <span class="text-sm text-base-content/60">Total Cashflow</span>
        </div>

        <% if monthly_cashflow.any? %>
          <% amounts = monthly_cashflow.values.map(&:abs).sort %>
          <% percentile_index = [(amounts.size * 0.90).ceil - 1, 0].max %>
          <% max_amount = amounts[percentile_index] %>
          
          <!-- Summary Section -->
          <div class="bg-base-300/50 rounded-lg p-3 mb-4 border border-base-300">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div>
                <div class="text-xs text-base-content/60 mb-1">Average Monthly</div>
                <div class="font-semibold <%= average_cashflow >= 0 ? 'text-success' : 'text-error' %>">
                  <%= number_to_currency(average_cashflow, unit: "€") %>
                </div>
              </div>
              <% if best_month %>
                <div>
                  <div class="text-xs text-base-content/60 mb-1">Best Month</div>
                  <div class="font-semibold text-success text-sm">
                    <%= number_to_currency(best_month[1], unit: "€") %>
                    <div class="text-xs text-base-content/60 font-normal">
                      <%= best_month[0].strftime("%b %Y") %>
                    </div>
                  </div>
                </div>
              <% end %>
              <% if worst_month && worst_month != best_month %>
                <div>
                  <div class="text-xs text-base-content/60 mb-1">Worst Month</div>
                  <div class="font-semibold text-error text-sm">
                    <%= number_to_currency(worst_month[1], unit: "€") %>
                    <div class="text-xs text-base-content/60 font-normal">
                      <%= worst_month[0].strftime("%b %Y") %>
                    </div>
                  </div>
                </div>
              <% end %>
              <div>
                <div class="text-xs text-base-content/60 mb-1">Trend</div>
                <div class="font-semibold <%= overall_trend >= 0 ? 'text-success' : 'text-error' %>">
                  <% if overall_trend > 0 %>
                    <span>↑</span>
                  <% elsif overall_trend < 0 %>
                    <span>↓</span>
                  <% else %>
                    <span>→</span>
                  <% end %>
                  <%= overall_trend.abs.round(1) %>%
                </div>
              </div>
            </div>
          </div>

          <!-- Monthly Breakdown -->
          <div class="space-y-3">
            <% monthly_cashflow.each_with_index do |(month, amount), index| %>
              <% month_data = monthly_breakdown[month] %>
              <% is_future_month = month > current_month %>
              <% trend_change = monthly_trends[month] %>
              <% is_above_average = amount > average_cashflow %>
              <% is_below_average = amount < average_cashflow %>
              
              <div class="flex flex-col gap-2 pb-3 <%= is_above_average ? 'bg-success/5' : (is_below_average ? 'bg-error/5' : '') %> rounded px-2 py-2">
                <!-- Row 1: Month name, Amount, and Trend (mobile-friendly) -->
                <div class="flex items-center justify-between gap-2 flex-wrap">
                  <div class="text-sm font-medium <%= is_future_month ? 'text-warning' : 'text-base-content' %>">
                    <%= month.strftime("%b %Y") %>
                  </div>
                  <div class="flex items-center gap-2">
                    <% if trend_change %>
                      <span class="text-xs <%= trend_change >= 0 ? 'text-success' : 'text-error' %> whitespace-nowrap">
                        <% if trend_change > 0 %>
                          ↑
                        <% elsif trend_change < 0 %>
                          ↓
                        <% end %>
                        <%= trend_change.abs.round(1) %>%
                      </span>
                    <% end %>
                    <span class="text-sm font-semibold <%= amount >= 0 ? 'text-success' : 'text-error' %> whitespace-nowrap">
                      <%= number_to_currency(amount, unit: "€") %>
                    </span>
                  </div>
                </div>
                
                <!-- Row 2: Bar chart (full width on mobile) -->
                <div class="relative h-6 bg-base-300 rounded overflow-hidden">
                  <div 
                    class="h-full <%= amount >= 0 ? 'bg-success' : 'bg-error' %> rounded transition-all duration-500"
                    style="width: <%= max_amount > 0 ? (amount.abs / max_amount * 100) : 0 %>%"
                  ></div>
                </div>
                
                <!-- Row 3: Ins/Outs breakdown -->
                <% if month_data %>
                  <div class="flex items-center gap-3 flex-wrap text-xs">
                    <span class="text-success">
                      +<%= number_to_currency(month_data[:ins], unit: "€") %>
                    </span>
                    <span class="text-error">
                      <%= number_to_currency(month_data[:outs], unit: "€") %>
                    </span>
                    <% if month_data[:count] %>
                      <span class="text-base-content/50">
                        (<%= pluralize(month_data[:count], 'transaction') %>)
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-base-content/60 italic">No transactions yet</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

